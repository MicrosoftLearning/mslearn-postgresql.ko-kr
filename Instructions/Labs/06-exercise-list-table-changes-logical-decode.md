---
lab:
  title: 논리 디코딩을 사용하여 테이블 변경 내용 나열
  module: Understand write-ahead logging
---

# 논리 디코딩을 사용하여 테이블 변경 내용 나열

이 연습에서는 PostgreSQL 네이티브 기능인 논리적 복제를 구성합니다. 게시자 및 구독자 역할을 하는 두 개의 서버를 만듭니다. zoodb의 데이터가 두 서버 사이에 복제됩니다.

## 시작하기 전에

이 연습을 완료하려면 자체 Azure 구독이 필요합니다. Azure 구독이 아직 없는 경우 [Azure 평가판](https://azure.microsoft.com/free)을 만들 수 있습니다.

## 리소스 그룹 만들기

1. Azure Portal에 로그인합니다. 사용자 계정은 Azure 구독의 Owner 또는 Contributor여야 합니다.
1. **리소스 그룹**을 선택한 다음 **+ 만들기**를 선택합니다.
1. 구독을 선택합니다.
1. 리소스 그룹에 **rg-PostgreSQL_Replication**을 입력합니다.
1. 현재 위치에 가까운 지역을 선택합니다.
1. **검토 + 만들기**를 선택합니다.
1. **만들기**를 선택합니다.

## 게시자 서버 만들기

1. Azure 서비스 아래에서 **+ 리소스 만들기**를 선택합니다. **범주** 아래에서 **데이터베이스**를 선택합니다. **Azure Database for PostgreSQL** 아래에서 **만들기**를 선택합니다.
1. 유연한 서버 **기본 사항** 탭에서 다음과 같이 각 필드에 입력합니다.
    1. 구독 - 사용자의 구독.
    1. 리소스 그룹 - **rg-PostgreSQL_Replication**을 선택합니다.
    1. 서버 이름 - **psql-postgresql-pub9999**(이름은 전역적으로 고유해야 하므로 9999를 4자리 난수로 바꿔야 함).
    1. 지역 - 리소스 그룹과 동일한 지역을 선택합니다.
    1. PostgreSQL 버전 - 16을 선택합니다.
    1. 워크로드 유형 - **개발**.
    1. 컴퓨팅 + 스토리지 - **버스트 가능**. **서버 구성**을 선택하고 구성 옵션을 검사합니다. 변경하지 않고 섹션을 닫습니다.
    1. 가용성 영역 - 1. 가용성 영역이 지원되지 않는 경우 기본 설정 없음으로 둡니다.
    1. 고가용성 - 사용 안 함.
    1. 인증 방법 - PostgreSQL 인증만.
    1. **관리 사용자 이름**에는 **`demo`** 을(를) 입력합니다.
    1. **암호**에는 적절히 복잡한 암호를 입력합니다.
    1. **다음: 네트워킹 >** 을 선택합니다.
1. 유연한 서버 **네트워킹** 탭에서 다음과 같이 각 필드에 입력합니다.
    1. 연결 방법: (o) 공용 액세스(허용된 IP 주소).
    1. **Azure 내의 모든 Azure 서비스의 이 서버에 대한 퍼블릭 액세스 허용** - 선택합니다. 게시자 데이터베이스와 구독자 데이터베이스가 서로 통신할 수 있도록 이 옵션을 선택해야 합니다.
    1. 방화벽 규칙 아래에서 **+ 현재 클라이언트 IP 주소 추가**를 선택합니다. 이렇게 하면 현재 IP 주소를 방화벽 규칙으로 추가합니다. 필요에 따라 이 방화벽 규칙의 이름을 의미 있는 것으로 지정할 수 있습니다.
1. **검토 + 만들기**를 선택합니다. 그런 다음 **만들기**를 선택합니다.
1. Azure Database for PostgreSQL을 만드는 데 몇 분 정도 걸릴 수 있으므로 이 배포의 진행이 시작되는 즉시 다음 단계를 시작합니다. 계속하기 위해 새 브라우저 창 또는 탭을 열어야 한다는 점에 유의하세요.

## 구독자 서버 만들기

1. Azure 서비스 아래에서 **+ 리소스 만들기**를 선택합니다. **범주** 아래에서 **데이터베이스**를 선택합니다. **Azure Database for PostgreSQL** 아래에서 **만들기**를 선택합니다.
1. 유연한 서버 **기본 사항** 탭에서 다음과 같이 각 필드에 입력합니다.
    1. 구독 - 사용자의 구독.
    1. 리소스 그룹 - **rg-PostgreSQL_Replication**을 선택합니다.
    1. 서버 이름 - **psql-postgresql-sub9999**(이름은 전역적으로 고유해야 하므로 9999를 4자리 난수로 바꿔야 함).
    1. 지역 - 리소스 그룹과 동일한 지역을 선택합니다.
    1. PostgreSQL 버전 - 16을 선택합니다.
    1. 워크로드 유형 - **개발**.
    1. 컴퓨팅 + 스토리지 - **버스트 가능**. **서버 구성**을 선택하고 구성 옵션을 검사합니다. 변경하지 않고 섹션을 닫습니다.
    1. 가용성 영역 - 2. 가용성 영역이 지원되지 않는 경우 기본 설정 없음으로 둡니다.
    1. 고가용성 - 사용 안 함.
    1. 인증 방법 - PostgreSQL 인증만.
    1. **관리 사용자 이름**에는 **`demo`** 을(를) 입력합니다.
    1. **암호**에는 적절히 복잡한 암호를 입력합니다.
    1. **다음: 네트워킹 >** 을 선택합니다.
1. 유연한 서버 **네트워킹** 탭에서 다음과 같이 각 필드에 입력합니다.
    1. 연결 방법: (o) 공용 액세스(허용된 IP 주소)
    1. **Azure 내의 모든 Azure 서비스의 이 서버에 대한 퍼블릭 액세스 허용** - 선택합니다. 게시자 데이터베이스와 구독자 데이터베이스가 서로 통신할 수 있도록 이 옵션을 선택해야 합니다.
    1. 방화벽 규칙 아래에서 **+ 현재 클라이언트 IP 주소 추가**를 선택합니다. 이렇게 하면 현재 IP 주소를 방화벽 규칙으로 추가합니다. 필요에 따라 이 방화벽 규칙의 이름을 의미 있는 것으로 지정할 수 있습니다.
1. **검토 + 만들기**를 선택합니다. 그런 다음 **만들기**를 선택합니다.
1. 두 Azure Database for PostgreSQL 서버가 모두 배포될 때까지 기다립니다.

## 복제 설정

게시자 및 구독자 서버 *모두*에 대해 다음과 같이 설정합니다.

1. Azure Portal에서 서버로 이동하고 설정 아래에서 **서버 매개 변수**를 선택합니다.
1. 검색 창을 사용하여 각 매개 변수를 찾아서 다음과 같이 변경합니다.
    1. `wal_level` = LOGICAL
    1. `max_worker_processes` = 24
1. **저장**을 선택합니다. 그런 다음 **저장 후 다시 시작**을 선택합니다.
1. 두 서버 모두 다시 시작될 때까지 기다립니다.

    > 참고 항목
    >
    > 서버를 다시 배포한 후에는 서버가 다시 시작된 것을 확인하기 위해 브라우저 창을 새로 고쳐야 할 수도 있습니다.

## 계속하기 전에 유의할 점이 있습니다.

다음 사항이 있는지 확인합니다.

1. Azure Database for PostgreSQL 유연한 서버를 둘 다 설치하고 시작했습니다.
1. 이미 [PostgreSQL Labs](https://github.com/MicrosoftLearning/mslearn-postgresql.git)에서 랩 스크립트를 복제했습니다. 앱 예제 리포지토리를 아직 로컬로 복제하지 않았다면 복제합니다.
    1. 명령줄/터미널을 엽니다.
    1. 명령 실행:
       ```bash
       md .\DP3021Lab
       git clone https://github.com/MicrosoftLearning/mslearn-postgresql.git .\DP3021Lab
       ```
       > 참고
       > 
       > **git**이 설치되지 않은 경우 [***git*** 앱을 다운로드하여 설치](https://git-scm.com/download)하고 이전 명령을 다시 실행해 봅니다.
1. Azure Data Studio를 설치했습니다. 아직 [***Azure Data Studio***를 다운로드 및 설치](https://go.microsoft.com/fwlink/?linkid=2282284)하지 않았다면 지금 합니다.
1. Azure Data Studio에서 **PostgreSQL** 확장을 설치합니다.

## 게시자 설정

1. Azure Data Studio를 열고 게시자 서버에 연결합니다. (개요 섹션에서 서버 이름을 복사합니다.)
1. **파일**, **파일 열기**를 선택하고 스크립트를 저장한 폴더로 이동합니다.
1. **../Allfiles/Labs/06/Lab6_Replication.sql** 스크립트를 열고 서버에 연결합니다.
1. **관리 사용자에게 복제 권한 부여** 섹션을 강조 표시하고 실행합니다.
1. **zoodb 데이터베이스 만들기** 섹션을 강조 표시하고 실행합니다.
1. 도구 모음의 드롭다운 목록을 사용하여 zoodb를 현재 데이터베이스로 선택합니다. **SELECT** 문을 실행하여 zoodb가 현재 데이터베이스인지 확인합니다.
1. zoodb에서 **테이블 만들기** 및 **외래 키 제약 조건** 섹션을 강조 표시하고 실행합니다.
1. **zoodb에서 테이블 채우기** 섹션을 강조 표시하고 실행합니다.
1. **게시 만들기** 섹션을 강조 표시하고 실행합니다. SELECT 문을 실행하면 복제가 아직 활성화되지 않았기 때문에 아무 것도 나열되지 않습니다.

## 구독자 설정

1. Azure Data Studio의 두 번째 인스턴스를 열고 구독자 서버에 연결합니다.
1. **파일**, **파일 열기**를 선택하고 스크립트를 저장한 폴더로 이동합니다.
1. **../Allfiles/Labs/06/Lab6_Replication.sql** 스크립트를 열고 구독자 서버에 연결합니다. (개요 섹션에서 서버 이름을 복사합니다.)
1. **관리 사용자에게 복제 권한 부여** 섹션을 강조 표시하고 실행합니다.
1. **zoodb 데이터베이스 만들기** 섹션을 강조 표시하고 실행합니다.
1. 도구 모음의 드롭다운 목록을 사용하여 zoodb를 현재 데이터베이스로 선택합니다. **SELECT** 문을 실행하여 zoodb가 현재 데이터베이스인지 확인합니다.
1. zoodb에서 **테이블 만들기** 및 **외래 키 제약 조건** 섹션을 강조 표시하고 실행합니다.
1. **구독 만들기** 섹션까지 아래로 스크롤합니다.
    1. **CREATE SUBSCRIPTION** 문을 편집하여 올바른 게시자 서버 이름과 강력한 게시자 암호를 입력합니다. 문을 강조 표시하고 실행합니다.
    1. **SELECT** 문을 강조 표시하고 실행합니다. 만든 구독 "sub"가 표시됩니다.
1. **테이블 표시** 섹션 아래에서 각 **SELECT** 문을 강조 표시하고 실행합니다. 테이블이 게시자의 복제로 채워졌습니다.

## 게시자 데이터베이스 변경

- Azure Data Studio의 첫 번째 인스턴스(*게시자 인스턴스*)에서 **더 많은 동물 삽입** 아래의 **INSERT** 문을 강조 표시하고 실행합니다. *이 INSERT 문을 구독자에서 실행하지 **않도록** 확인합니다*.

## 구독자 데이터베이스에서 변경 내용 보기

- Azure Data Studio(구독자)의 두 번째 인스턴스에서 **동물 테이블 표시** 아래의 **SELECT** 문을 강조 표시하고 실행합니다.

이제 두 개의 Azure Database for PostgreSQL 유연한 서버를 만들고 하나는 게시자로 구성하고 다른 하나는 구독자로 구성했습니다. 게시자 데이터베이스에서 zoo 데이터베이스를 만들고 채웠습니다. 구독자 데이터베이스에서 빈 데이터베이스를 만들고 스트리밍 복제로 채웠습니다.

## 정리

1. 연습을 완료한 후 두 서버를 포함하는 리소스 그룹을 삭제합니다. 서버를 중지 또는 삭제하지 않을 경우 서버에 대한 요금이 청구됩니다.
1. 필요한 경우 .\DP3021Lab 폴더를 삭제합니다.
