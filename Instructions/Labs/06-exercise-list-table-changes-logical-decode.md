---
lab:
  title: 논리 디코딩을 사용하여 테이블 변경 내용 나열
  module: Understand write-ahead logging
---

# 논리 디코딩을 사용하여 테이블 변경 내용 나열

이 연습에서는 PostgreSQL에 네이티브인 논리 복제를 구성합니다. 게시자와 구독자 역할을 하는 두 개의 서버를 만듭니다. zoodb의 데이터는 이들 간에 복제됩니다.

## 시작하기 전에

이 연습을 완료하려면 자체 Azure 구독이 필요합니다. Azure 구독이 아직 없는 경우 [Azure 평가판](https://azure.microsoft.com/free)을 만들 수 있습니다.

또한 컴퓨터에 다음이 설치되어 있어야 합니다.

- Visual Studio Code
- Microsoft의 Postgres Visual Studio Code 확장.
- Azure CLI
- Git

## 연습 환경 만들기

이 연습과 이후 연습에서는 Bicep 스크립트를 사용하여 Azure Database for PostgreSQL - 유연한 서버 및 기타 리소스를 Azure 구독에 배포합니다. Bicep 스크립트는 앞서 복제한 GitHub 리포지토리의 `/Allfiles/Labs/Shared` 폴더에 있습니다.

### Visual Studio Code 및 PostgreSQL 확장을 다운로드하여 설치합니다.

Visual Studio Code가 설치되어 있지 않은 경우:

1. 브라우저에서 [Visual Studio Code 다운로드](https://code.visualstudio.com/download)로 이동하여 운영 체제에 맞는 버전을 선택합니다.

1. 사용 중인 운영 체제의 설치 지침을 따르세요.

1. Visual Studio Code를 엽니다.

1. 왼쪽 메뉴에서 **확장**을 선택하여 확장 패널을 표시합니다.

1. 검색 창에 **PostgreSQL**을 입력합니다. Visual Studio Code용 PostgreSQL 확장 아이콘이 표시됩니다. Microsoft에서 제공하는 것을 선택해야 합니다.

1. **설치**를 선택합니다. 확장이 설치됩니다.

### Azure CLI 및 Git 다운로드 및 설치

Azure CLI 또는 Git이 설치되어 있지 않은 경우:

1. 브라우저에서 [Azure CLI 설치](https://learn.microsoft.com/cli/azure/install-azure-cli)로 이동하여 운영 체제별 지침을 따릅니다.

1. 브라우저에서 [Git 다운로드 및 설치](https://git-scm.com/downloads)로 이동하여 운영 체제별 지침을 따릅니다.

### 연습 파일 다운로드

연습 파일이 포함된 GitHub 리포지토리를 이미 복제한 경우 *연습 파일 다운로드 건너뛰기*로 이동합니다.

연습 파일을 다운로드하려면 연습 파일이 포함된 GitHub 리포지토리를 로컬 컴퓨터에 복제합니다. 리포지토리에는 이 연습을 완료하는 데 필요한 모든 스크립트와 리소스가 포함되어 있습니다.

1. 아직 열려 있지 않은 경우 Visual Studio Code를 엽니다.

1. 명령 팔레트를 열려면 **모든 명령 표시**(Ctrl+Shift+P)를 선택합니다.

1. 명령 팔레트에서 **Git: Clone**을 검색하고 선택합니다.

1. 명령 팔레트에서 다음을 입력하여 연습 리소스가 포함된 GitHub 리포지토리를 복제하고 **Enter** 키를 누릅니다.

    ```bash
    https://github.com/MicrosoftLearning/mslearn-postgresql.git
    ```

1. 프롬프트에 따라 리포지토리를 복제할 폴더를 선택합니다. 리포지토리는 선택한 위치의 `mslearn-postgresql`라는 폴더에 복제됩니다.

1. 복제된 리포지토리를 열지 묻는 메시지가 표시되면 **열기**를 선택합니다. 리포지토리는 Visual Studio Code에서 열립니다.

## 리소스 그룹 만들기

이 섹션에서는 Azure Database for PostgreSQL 서버를 포함할 리소스 그룹을 만듭니다. 리소스 그룹은 Azure 솔루션에 관련된 리소스를 보유하는 논리 컨테이너입니다.

1. Azure Portal에 로그인합니다. 사용자 계정은 Azure 구독의 Owner 또는 Contributor여야 합니다.

1. **리소스 그룹**을 선택한 다음 **+ 만들기**를 선택합니다.

1. 구독을 선택합니다.

1. 리소스 그룹에 **rg-PostgreSQL_Replication**을 입력합니다.

1. 현재 위치에 가까운 지역을 선택합니다.

1. **검토 + 만들기**를 선택합니다.

1. **만들기**를 선택합니다.

## 게시자 서버 만들기

이 섹션에서는 게시자 서버를 만듭니다. 게시자 서버는 구독자 서버에 복제할 데이터의 원본입니다.

1. Azure 서비스 아래에서 **+ 리소스 만들기**를 선택합니다. **범주** 아래에서 **데이터베이스**를 선택합니다. **Azure Database for PostgreSQL** 아래에서 **만들기**를 선택합니다.

1. 유연한 서버 **기본 사항** 탭에서 다음과 같이 각 필드에 입력합니다.
    - **구독** - 사용자의 구독.
    - **리소스 그룹** - **rg-PostgreSQL_Replication**를 선택합니다.
    - **서버 이름** - *psql-postgresql-pub9999*(이름은 전역적으로 고유해야 하므로 9999를 4자리 난수로 바꿔야 함).
    - **지역** - 리소스 그룹과 동일한 지역을 선택합니다.
    - **PostgreSQL 버전** - 16을 선택합니다.
    - **워크로드 유형** - *개발.*
    - **컴퓨팅 + 스토리지** - *버스트 가능*. **서버 구성**을 선택하고 구성 옵션을 검사합니다. 변경하지 않고 섹션을 닫습니다.
    - **가용성 영역** - 1. 가용성 영역이 지원되지 않는 경우 기본 설정 없음으로 둡니다.
    - **고가용성** - 사용 안 함.
    - **인증 방법** - PostgreSQL 인증만 가능.
    - **admin 사용자 이름**, **`pgAdmin`** 을(를) 입력합니다.
    - **비밀번호**에 적절한 복잡한 비밀번호를 입력합니다.

1. **다음: 네트워킹 >** 을 선택합니다.

1. 유연한 서버 **네트워킹** 탭에서 다음과 같이 각 필드에 입력합니다.
    - **연결 방법**: (o) 공용 액세스(허용된 IP 주소).
    - **Azure 내의 모든 Azure 서비스에서 이 서버에 대한 공용 액세스 허용**: 확인됨. 이 확인란을 선택해야 게시자와 구독자 데이터베이스가 서로 통신할 수 있습니다.
    - **방화벽 규칙**: **+ 현재 클라이언트 IP 주소 추가**를 선택합니다. 이 옵션은 현재 IP 주소를 방화벽 규칙으로 추가합니다. 필요에 따라 이 방화벽 규칙의 이름을 의미 있는 것으로 지정할 수 있습니다.

1. **검토 + 만들기**를 선택합니다. 그런 다음 **만들기**를 선택합니다.

1. Azure Database for PostgreSQL을 만드는 데 몇 분 정도 걸릴 수 있으므로 이 배포의 진행이 시작되는 즉시 다음 단계를 시작합니다. 계속하기 위해 새 브라우저 창 또는 탭을 열어야 한다는 점에 유의하세요.

## 구독자 서버 만들기

1. Azure 서비스 아래에서 **+ 리소스 만들기**를 선택합니다. **범주** 아래에서 **데이터베이스**를 선택합니다. **Azure Database for PostgreSQL** 아래에서 **만들기**를 선택합니다.

1. 유연한 서버 **기본 사항** 탭에서 다음과 같이 각 필드에 입력합니다.
    - **구독** - 사용자의 구독.
    - **리소스 그룹** - **rg-PostgreSQL_Replication**를 선택합니다.
    - **서버 이름** - *psql-postgresql-sub9999*(이름은 전역에서 고유해야 하므로 9999를 4자리 난수로 바꿔야 함).
    - **지역** - 리소스 그룹과 동일한 지역을 선택합니다.
    - **PostgreSQL 버전** - 16을 선택합니다.
    - **워크로드 유형** - *개발.*
    - **컴퓨팅 + 스토리지** - *버스트 가능*. **서버 구성**을 선택하고 구성 옵션을 검사합니다. 변경하지 않고 섹션을 닫습니다.
    - **가용성 영역** - 2. 가용성 영역이 지원되지 않는 경우 기본 설정 없음으로 둡니다.
    - **고가용성** - 사용 안 함.
    - **인증 방법** - PostgreSQL 인증만 가능.
    - **admin 사용자 이름**, **`pgAdmin`** 을(를) 입력합니다.
    - **비밀번호**에 적절한 복잡한 비밀번호를 입력합니다.

1. **다음: 네트워킹 >** 을 선택합니다.

1. 유연한 서버 **네트워킹** 탭에서 다음과 같이 각 필드에 입력합니다.
    - **연결 방법**: (o) 공용 액세스(허용된 IP 주소).
    - **Azure 내의 모든 Azure 서비스에서 이 서버에 대한 공용 액세스 허용**: 확인됨. 이 확인란을 선택해야 게시자와 구독자 데이터베이스가 서로 통신할 수 있습니다.
    - **방화벽 규칙**: **+ 현재 클라이언트 IP 주소 추가**를 선택합니다. 이 옵션은 현재 IP 주소를 방화벽 규칙으로 추가합니다. 필요에 따라 이 방화벽 규칙의 이름을 의미 있는 것으로 지정할 수 있습니다.

1. **검토 + 만들기**를 선택합니다. 그런 다음 **만들기**를 선택합니다.

1. 두 Azure Database for PostgreSQL 서버가 모두 배포될 때까지 기다립니다.

## 복제 설정

게시자 및 구독자 서버 *모두*에 대해 다음과 같이 설정합니다.

1. Azure Portal에서 서버로 이동하고 설정 아래에서 **서버 매개 변수**를 선택합니다.

1. 검색 창을 사용하여 각 매개 변수를 찾아서 다음과 같이 변경합니다.
    - `wal_level` = LOGICAL
    - `max_worker_processes` = 24

1. **저장**을 선택합니다. 그런 다음 **저장 후 다시 시작**을 선택합니다.

1. 두 서버 모두 다시 시작될 때까지 기다립니다.

    > &#128221; 서버가 다시 배포된 후 서버가 다시 시작되었는지 확인하려면 브라우저 창을 새로 고쳐야 할 수 있습니다.

## 게시자 설정

이 섹션에서는 게시자 서버를 설정합니다. 게시자 서버는 구독자 서버에 복제할 데이터의 원본입니다.

1. Visual Studio Code의 첫 번째 인스턴스를 열어 게시자 서버에 연결합니다.

1. GitHub 리포지토리를 복제한 폴더를 엽니다.

1. 왼쪽 메뉴에서 **PostgreSQL** 아이콘을 선택합니다.

    > &#128221; PostgreSQL 아이콘이 보이지 않는 경우, **확장** 아이콘을 선택한 다음 **PostgreSQL**을 검색합니다. Microsoft의 **PostgreSQL** 확장을 선택하고 **설치**를 선택합니다.

1. 이미 PostgreSQL *게시자* 서버에 대한 연결을 만든 경우 다음 단계로 건너뜁니다. 새 연결을 만들려면 다음과 같이 합니다.

    1. **PostgreSQL** 확장에서 **+ 연결 추가**를 선택하여 새 연결을 추가합니다.

    1. **새 연결** 대화 상자에서 다음 정보를 입력합니다.

        - **서버 이름**: `<your-publisher-server-name>`.postgres.database.azure.com
        - **인증 유형**: 암호
        - **사용자 이름**: pgAdmin
        - **암호**: 이전에 생성한 임의의 암호입니다.
        - **비밀번호 저장** 확인란을 선택합니다.
        - **연결 이름**: `<your-publisher-server-name>`

    1. 연결을 테스트하려면 **연결 테스트**를 선택합니다. 연결에 성공하면 **저장 후 연결**을 선택하여 연결을 저장하고, 성공하지 않으면 연결 정보를 검토한 후 다시 시도합니다.

1. 아직 연결되지 않은 경우, PostgreSQL 서버에 대해 **연결**을 선택합니다. Azure Database for PostgreSQL 서버에 연결되어 있습니다.

1. 서버 노드 및 해당 데이터베이스를 확장합니다. 기존 데이터베이스가 나열됩니다.

1. Visual Studio Code에서 **파일**, **파일 열기**를 선택한 후 스크립트를 저장한 폴더로 이동합니다. **../Allfiles/Labs/06/Lab6_Replication.sql** 및 **열기**를 선택합니다.

1. Visual Studio Code의 오른쪽 하단에서 연결이 녹색인지 확인합니다. 그렇지 않은 경우 **PGSQL 연결 끊김**이라고 표시되어야 합니다. **PGSQL 연결 끊김** 텍스트를 선택한 다음 명령 팔레트의 목록에서 PostgreSQL 서버 연결을 선택합니다. 비밀번호를 묻는 메시지가 표시되면 이전에 생성한 비밀번호를 입력합니다.

1. *게시자*를 설정할 시간입니다.

    1. **관리 사용자에게 복제 권한 부여** 섹션을 강조 표시하고 실행합니다.

    1. **zoodb 데이터베이스 만들기** 섹션을 강조 표시하고 실행합니다.

    1. **SELECT current_database()** 문만 강조 표시하고 실행하면 데이터베이스가 현재 `postgres`(으)로 설정되어 있는 것을 확인할 수 있습니다. `zoodb`(으)로 변경해야 합니다.

    1. 메뉴 모음에서 *실행* 아이콘이 있는 줄임표를 선택하고 **PostgreSQL 데이터베이스 변경**을 선택합니다. 데이터베이스 목록에서 `zoodb`을(를) 선택합니다.

        > &#128221; 쿼리 창에서 데이터베이스를 변경할 수도 있습니다. 쿼리 탭 자체에서 서버 이름과 데이터베이스 이름을 확인할 수 있습니다. 데이터베이스 이름을 선택하면 데이터베이스 목록이 표시됩니다. 목록에서 `zoodb` 데이터베이스를 선택합니다.

    1. zoodb에서 **테이블 만들기** 및 **외래 키 제약 조건** 섹션을 강조 표시하고 실행합니다.

    1. **zoodb에서 테이블 채우기** 섹션을 강조 표시하고 실행합니다.

    1. **게시 만들기** 섹션을 강조 표시하고 실행합니다. SELECT 문을 실행하면 복제가 아직 활성화되지 않았기 때문에 아무 것도 나열되지 않습니다.

    1. **구독 만들기** 섹션을 실행하지 않습니다. 이 스크립트는 구독자 서버에서 실행됩니다.

    1. 이 Visual Studio Code 인스턴스를 닫지 말고 최소화하기만 하면 됩니다. 구독자 서버를 설정한 후 다시 돌아갑니다.

이제 게시자 서버와 zoodb 데이터베이스를 만들었습니다. 데이터베이스에는 구독자 서버에 복제되는 테이블과 데이터가 포함됩니다.

## 구독자 설정

이 섹션에서는 구독자 서버를 설정합니다. 구독자 서버는 게시자 서버에서 복제되는 데이터의 대상입니다. 구독자 서버에 게시자 서버의 데이터로 채워진 새 데이터베이스를 만듭니다.

1. Visual Studio Code의 *두 번째 인스턴스*를 열어 구독자 서버에 연결합니다.

1. GitHub 리포지토리를 복제한 폴더를 엽니다.

1. 왼쪽 메뉴에서 **PostgreSQL** 아이콘을 선택합니다.

    > &#128221; PostgreSQL 아이콘이 보이지 않는 경우, **확장** 아이콘을 선택한 다음 **PostgreSQL**을 검색합니다. Microsoft의 **PostgreSQL** 확장을 선택하고 **설치**를 선택합니다.

1. 이미 PostgreSQL *구독자* 서버에 대한 연결을 만든 경우 다음 단계로 건너뜁니다. 새 연결을 만들려면 다음과 같이 합니다.

    1. **PostgreSQL** 확장에서 **+ 연결 추가**를 선택하여 새 연결을 추가합니다.

    1. **새 연결** 대화 상자에서 다음 정보를 입력합니다.

        - **서버 이름**: `<your-subscriber-server-name>`.postgres.database.azure.com
        - **인증 유형**: 암호
        - **사용자 이름**: pgAdmin
        - **암호**: 이전에 생성한 임의의 암호입니다.
        - **비밀번호 저장** 확인란을 선택합니다.
        - **연결 이름**: `<your-subscriber-server-name>`

    1. 연결을 테스트하려면 **연결 테스트**를 선택합니다. 연결에 성공하면 **저장 후 연결**을 선택하여 연결을 저장하고, 성공하지 않으면 연결 정보를 검토한 후 다시 시도합니다.

1. 아직 연결되지 않은 경우, PostgreSQL 서버에 대해 **연결**을 선택합니다. Azure Database for PostgreSQL 서버에 연결되어 있습니다.

1. 서버 노드 및 해당 데이터베이스를 확장합니다. 기존 데이터베이스가 나열됩니다.

1. Visual Studio Code에서 **파일**, **파일 열기**를 선택한 후 스크립트를 저장한 폴더로 이동합니다. **../Allfiles/Labs/06/Lab6_Replication.sql** 및 **열기**를 선택합니다.

1. Visual Studio Code의 오른쪽 하단에서 연결이 녹색인지 확인합니다. 그렇지 않은 경우 **PGSQL 연결 끊김**이라고 표시되어야 합니다. **PGSQL 연결 끊김** 텍스트를 선택한 다음 명령 팔레트의 목록에서 PostgreSQL 서버 연결을 선택합니다. 비밀번호를 묻는 메시지가 표시되면 이전에 생성한 비밀번호를 입력합니다.

1. *구독자*를 설정할 시간입니다.

    1. **관리 사용자에게 복제 권한 부여** 섹션을 강조 표시하고 실행합니다.

    1. **zoodb 데이터베이스 만들기** 섹션을 강조 표시하고 실행합니다.

    1. **SELECT current_database()** 문만 강조 표시하고 실행하면 데이터베이스가 현재 `postgres`(으)로 설정되어 있는 것을 확인할 수 있습니다. `zoodb`(으)로 변경해야 합니다.

    1. 메뉴 모음에서 *실행* 아이콘이 있는 줄임표를 선택하고 **PostgreSQL 데이터베이스 변경**을 선택합니다. 데이터베이스 목록에서 `zoodb`을(를) 선택합니다.

        > &#128221; 쿼리 창에서 데이터베이스를 변경할 수도 있습니다. 쿼리 탭 자체에서 서버 이름과 데이터베이스 이름을 확인할 수 있습니다. 데이터베이스 이름을 선택하면 데이터베이스 목록이 표시됩니다. 목록에서 `zoodb` 데이터베이스를 선택합니다.

    1. `zoodb`에서 **테이블 만들기** 및 **외래 키 제약 조건** 섹션을 강조 표시하고 실행합니다.

    1. **게시물 만들기** 섹션을 실행하지 않습니다. 해당 문은 이미 게시자 서버에서 실행되었습니다.

    1. **구독 만들기** 섹션까지 아래로 스크롤합니다.

        1. **CREATE SUBSCRIPTION** 문을 편집하여 올바른 게시자 서버 이름과 강력한 게시자 암호를 입력합니다. 문을 강조 표시하고 실행합니다.

        1. **SELECT** 문을 강조 표시하고 실행합니다. 여기에는 이전에 생성한 구독 "sub"가 표시됩니다.

    1. **테이블 표시** 섹션에서 각 **SELECT** 문을 강조 표시하고 실행합니다. 게시자 서버는 복제를 통해 이러한 테이블을 채웠습니다.

구독자 서버와 zoodb 데이터베이스를 만들었습니다. 데이터베이스에는 게시자 서버에서 복제된 테이블과 데이터가 포함되어 있습니다.

## 게시자 데이터베이스 변경

- Visual Studio Code의 첫 번째 인스턴스(*게시자 인스턴스*)의 **Insert more animals** 아래에서 **INSERT** 문을 강조 표시하고 실행합니다. *이 INSERT 문을 구독자에서 실행하지 **않도록** 확인합니다*.

## 구독자 데이터베이스에서 변경 내용 보기

- Visual Studio Code(구독자)의 두 번째 인스턴스에서 **Display the animal tables** 아래의 **SELECT** 문을 강조 표시하고 실행합니다.

이제 두 개의 Azure Database for PostgreSQL 유연한 서버를 만들고 하나는 게시자로 구성하고 다른 하나는 구독자로 구성했습니다. 게시자 데이터베이스에서 zoo 데이터베이스를 만들고 채웠습니다. 구독자 데이터베이스에서 빈 데이터베이스를 만들고 스트리밍 복제로 채웠습니다.

## 정리

1. 다른 연습에 이 PostgreSQL 서버가 더 이상 필요하지 않은 경우, 불필요한 Azure 비용이 발생하지 않도록 이 연습에서 만든 리소스 그룹을 삭제합니다.

1. PostgreSQL 서버를 계속 실행하려면 실행 상태로 두면 됩니다. 서버를 계속 실행하지 않으려면 bash 터미널에서 서버를 중지하여 불필요한 비용이 발생하지 않도록 할 수 있습니다. 서버를 중지하려면 각 서버에 대해 다음 명령을 실행합니다.

    ```bash

    ```azurecli
    az postgres flexible-server stop --name <your-server-name> --resource-group $RG_NAME
    ```

    `<your-server-name>`을(를) PostgreSQL 서버의 이름으로 바꿉니다.

    > &#128221; Azure Portal에서 서버를 중지할 수도 있습니다. Azure Portal에서 **리소스 그룹**으로 이동하여 이전에 만든 리소스 그룹을 선택합니다. PostgreSQL 서버를 선택한 다음 메뉴에서 **중지**를 선택합니다. 게시자 및 구독자 서버 모두에 대해 다음과 같이 설정합니다.

1. 필요한 경우 이전에 복제한 git 리포지토리를 삭제합니다.

PostgreSQL 서버를 성공적으로 만들고 논리적 복제를 위해 구성했습니다. 게시자 서버와 구독자 서버를 만들었으며, 게시자 서버 간에 복제를 설정했습니다. 또한 게시자 데이터베이스를 변경하고 구독자 데이터베이스의 변경 내용을 확인했습니다. 이제 PostgreSQL에서 논리적 복제를 설정하는 방법을 잘 알고 있습니다.
