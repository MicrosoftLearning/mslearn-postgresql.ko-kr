---
lab:
  title: Azure Database for PostgreSQL 권한 구성
  module: Secure Azure Database for PostgreSQL
---

# Azure Database for PostgreSQL 권한 구성

이러한 랩 연습에서는 RBAC 역할을 할당하여 Azure Database for PostgreSQL 리소스에 대한 액세스를 제어하고, PostgreSQL GRANTS를 할당하여 데이터베이스 작업에 대한 액세스를 제어합니다.

## 시작하기 전에

이 연습을 완료하려면 자체 Azure 구독이 필요합니다. Azure 구독이 없으면 [Azure 평가판](https://azure.microsoft.com/free)을 만드세요.

이 연습을 완료하려면 Microsoft Entra ID(이전의 Azure Active Directory)에 연결된 PostgreSQL 서버를 설치해야 합니다.

### 리소스 그룹 만들기

1. 웹 브라우저에서 [Azure Portal](https://portal.azure.com)로 이동합니다. 소유자 또는 기여자 계정을 사용하여 로그인합니다.
2. Azure 서비스 아래 **리소스 그룹**을 선택한 다음 **+ 만들기**를 선택합니다.
3. 올바른 구독이 표시되는지 확인한 다음, 리소스 그룹 이름에 **rg-PostgreSQL_Entra**를 입력합니다. **지역**을 선택합니다.
4. **검토 + 만들기**를 선택합니다. 그런 다음 **만들기**를 선택합니다.

## Azure Database for PostgreSQL 유연한 서버 만들기

1. Azure 서비스 아래에서 **+ 리소스 만들기**를 선택합니다.
    1. **마켓플레이스 검색**에서 **`azure database for postgresql flexible server`** 입력 후, **Azure Database for PostgreSQL 유연한 서버**를 선택한 다음 **만들기**를 클릭합니다.
1. 유연한 서버 **기본 사항** 탭에서 다음과 같이 각 필드에 입력합니다.
    1. 구독 - 사용자의 구독.
    1. 리소스 그룹 - **rg-PostgreSQL_Entra**.
    1. 서버 이름 - **psql-postgresql-fx7777**(서버 이름은 전역적으로 고유해야 하므로 7777을 4자리 난수로 바꿔야 함).
    1. 지역 - 리소스 그룹과 동일한 지역을 선택합니다.
    1. PostgreSQL 버전 - 16을 선택합니다.
    1. 워크로드 유형 - **개발**.
    1. 컴퓨팅 + 스토리지 - **버스트 가능, B1ms**.
    1. 가용성 영역 - 기본 설정 없음.
    1. 고가용성 - 선택하지 않은 상태로 둡니다.
    1. 인증 방법 - **PostgreSQL 및 Microsoft Entra 인증**을 선택합니다.
    1. Microsoft Entra 관리자 설정 - **관리자 설정**을 선택합니다.
        1. **Microsoft Entra 관리자 선택**에서 사용할 계정을 검색하고 계정에 (o) 적용 후 **선택**을 클릭합니다.
    1. **관리 사용자 이름**에는 **`demo`** 을(를) 입력합니다.
    1. **암호**에 적절히 복잡한 암호를 입력합니다.
    1. **다음: 네트워킹 >** 을 선택합니다.
1. 유연한 서버 **네트워킹** 탭에서 다음과 같이 각 필드에 입력합니다.
    1. 연결 방법: (o) 공용 액세스(허용된 IP 주소) 및 프라이빗 엔드포인트
    1. 공용 액세스, **공용 IP 주소를 사용하여 인터넷을 통해 이 리소스에 대한 공용 액세스 허용**을 선택합니다.
    1. 방화벽 규칙 아래에서 **+ 현재 클라이언트 IP 주소 추가**를 선택하여 현재 IP 주소를 방화벽 규칙으로 추가합니다. 필요에 따라 이 방화벽 규칙의 이름을 의미 있는 것으로 지정할 수 있습니다. 또한 **0.0.0.0 - 255.255.255.255 추가**를 추가하고 **계속**을 클릭합니다.
1. **검토 + 만들기**를 선택합니다. 설정을 검토한 다음 **만들기**를 선택하여 Azure Database for PostgreSQL 유연한 서버를 만듭니다. 배포가 완료되면 다음 단계를 위해 준비된 **리소스로 이동**을 선택합니다.

## Azure Data Studio 설치

Azure Database for PostgreSQL에서 사용할 Azure Data Studio를 설치하려면 다음을 수행합니다.

1. 브라우저에서 [Azure Data Studio 다운로드 및 설치](/sql/azure-data-studio/download-azure-data-studio)로 이동하고 Windows 플랫폼에서 **사용자 설치 관리자(권장)** 를 선택합니다. 실행 파일이 다운로드 폴더에 다운로드됩니다.
1. **폴더 열기**를 선택합니다.
1. 사용권 계약이 표시됩니다. **사용 약관을 읽고 이에 동의**한 후 **다음**을 선택합니다.
1. **추가 작업 선택**에서 **PATH에 추가** 및 필요한 기타 추가 항목을 선택합니다. **다음**을 선택합니다.
1. **설치 준비** 대화 상자가 표시됩니다. 설정을 검토합니다. **뒤로**를 선택하여 변경하거나 **설치**를 선택합니다.
1. **Azure Data Studio 설치 마법사 완료** 대화 상자가 표시됩니다. **마침**을 선택합니다. Azure Data Studio가 시작됩니다.

### PostgreSQL 확장 설치

1. Azure Data Studio가 열려 있지 않으면 엽니다.
1. 왼쪽 메뉴에서 **확장**을 선택하여 확장 패널을 표시합니다.
1. 검색 창에 **PostgreSQL**을 입력합니다. Azure Data Studio에 대한 PostgreSQL 확장 아이콘이 표시됩니다.
1. **설치**를 선택합니다. 확장이 설치됩니다.

### Azure Database for PostgreSQL 유연한 서버에 연결

1. Azure Data Studio가 열려 있지 않으면 엽니다.
1. 왼쪽 메뉴에서 **연결**을 선택합니다.
1. **새 연결**을 선택합니다.
1. **연결 세부 정보** 아래 **연결 유형**의 드롭다운 목록에서 **PostgreSQL**을 선택합니다.
1. **서버 이름**에 Azure Portal에 표시되는 전체 서버 이름을 입력합니다.
1. **인증 유형**에서 암호를 그대로 둡니다.
1. 사용자 이름 및 암호에 사용자 이름 **demo**와 위에서 만든 복잡한 암호를 입력합니다.
1. [ x ] 암호 저장을 선택합니다.
1. 나머지 필드는 선택 사항입니다.
1. **연결**을 선택합니다. Azure Database for PostgreSQL 서버에 연결되어 있습니다.
1. 서버 데이터베이스 목록이 표시됩니다. 여기에는 시스템 데이터베이스 및 사용자 데이터베이스가 포함됩니다.

### Zoo 데이터베이스 만들기

1. 연습 스크립트 파일이 있는 폴더로 이동하거나 [MSLearn PostgreSQL Labs](https://github.com/MicrosoftLearning/mslearn-postgresql/Allfiles/Labs/02)에서 **Lab2_ZooDb.sql**을 다운로드합니다.
1. Azure Data Studio가 열려 있지 않으면 엽니다.
1. **파일**, **파일 열기**를 선택하고 스크립트를 저장한 폴더로 이동합니다. **../Allfiles/Labs/02/Lab2_ZooDb.sql**와 **열기**를 선택합니다. 신뢰 경고가 표시되면 **열기**를 선택합니다.
1. 스크립트를 실행합니다. zoodb 데이터베이스가 만들어집니다.

## Microsoft Entra ID에서 새 사용자 계정 만들기

> [!NOTE]
> 대부분의 프로덕션 또는 개발 환경에서는 Microsoft Entra ID 서비스에 계정을 만들 수 있는 구독 계정 권한이 없을 확률이 높습니다.  이 경우 조직에서 허용한다면 Microsoft Entra ID 관리자에게 테스트 계정을 만들어 달라고 요청합니다. 테스트 Entra 계정을 만들 수 없는 경우 이 섹션을 건너뛰고 **Azure Database for PostgreSQL에 대한 GRANT 액세스 권한 부여** 섹션으로 계속 진행합니다. 

1. [Azure Portal](https://portal.azure.com)에서 소유자 계정을 사용하여 로그인하고 Microsoft Entra ID로 이동합니다.
1. **관리**에서 **사용자**를 선택합니다.
1. 왼쪽 위에서 **새 사용자**를 선택한 다음, **새 사용자 만들기**를 선택합니다.
1. **새 사용자** 페이지에서 다음 세부 정보를 입력한 다음 **만들기**를 선택합니다.
    - **사용자 계정 이름:** 사용자 계정 이름을 선택합니다.
    - **표시 이름:** 표시 이름을 선택합니다.
    - **암호:** **암호 자동 생성**의 선택을 해제한 다음 강력한 암호를 입력합니다. 사용자 계정 이름 및 암호를 기록해 둡니다.
    - **검토 + 만들기**를 클릭합니다.

    > [!TIP]
    > 사용자가 생성되면 나중에 로그인할 때 사용할 수 있도록 전체 **사용자 계정 이름**을 메모해 둡니다.

### 읽기 권한자 역할 할당

1. Azure Portal에서 **모든 리소스**를 선택한 다음, Azure Database for PostgreSQL 리소스를 선택합니다.
1. **액세스 제어(IAM)** 를 선택한 다음, **역할 할당**을 선택합니다. 새 계정이 목록에 표시되지 않습니다.
1. **+ 추가**를 선택한 다음, **역할 할당 추가**를 선택합니다.
1. **읽기 권한자** 역할을 선택하고 **다음**을 선택합니다.
1. **+ 구성원 선택**을 선택하고, 이전 단계에서 추가한 새 계정을 구성원 목록에 추가한 다음 **다음**을 선택합니다.
1. **검토 + 할당**을 선택합니다.

### 읽기 권한자 역할 테스트

1. Azure Portal의 오른쪽 위에서 사용자 계정을 선택한 다음 **로그아웃**을 선택합니다.
1. 메모해 둔 사용자 계정 이름과 암호를 사용하여 새 사용자로 로그인합니다. 메시지가 표시되면 기본 암호를 바꾸고 새 암호를 메모해 둡니다.
1. 다단계 인증을 묻는 메시지가 표시되면 **나중에 물어보기**를 선택합니다.
1. 포털 홈페이지에서 **모든 리소스**를 선택한 다음, Azure Database for PostgreSQL 리소스를 선택합니다.
1. **중지**를 선택합니다. 읽기 권한자 역할을 사용하면 리소스를 볼 수 있지만 변경할 수는 없으므로 오류가 표시됩니다.

### 기여자 역할 할당

1. Azure Portal의 오른쪽 위에서 새 사용자의 사용자 계정을 선택한 다음 **로그아웃**을 선택합니다.
1. 원래 소유자 계정을 사용하여 로그인합니다.
1. Azure Database for PostgreSQL 리소스로 이동한 다음 **액세스 제어(IAM)** 를 선택합니다.
1. **+ 추가**를 선택한 다음, **역할 할당 추가**를 선택합니다.
1. **권한 있는 관리자 역할**을 선택합니다.
1. **기여자** 역할을 선택하고 **다음**을 선택합니다.
1. 이전에 추가한 새 계정을 구성원 목록에 추가한 후, **다음**을 선택합니다.
1. **검토 + 할당**을 선택합니다.
1. **역할 할당**을 선택합니다. 새 계정은 이제 읽기 권한자 및 기여자 역할 둘 다에 할당되어 있습니다.

## 기여자 역할 테스트

1. Azure Portal의 오른쪽 위에서 사용자 계정을 선택한 다음 **로그아웃**을 선택합니다.
1. 메모해 둔 사용자 계정 이름과 암호를 사용하여 새 계정으로 로그인합니다.
1. 포털 홈페이지에서 **모든 리소스**를 선택한 다음, Azure Database for MySQL 리소스를 선택합니다.
1. **중지**를 선택한 다음 **예**를 선택합니다. 이번에는 새 계정에 필요한 역할이 할당되어 있으므로 서버가 오류 없이 중지됩니다.
1. **시작**을 선택하여 PostgreSQL 서버가 다음 단계를 수행할 준비가 되었는지 확인합니다.
1. Azure Portal의 오른쪽 위에서 새 사용자의 사용자 계정을 선택한 다음 **로그아웃**을 선택합니다.
1. 원래 소유자 계정을 사용하여 로그인합니다.

## Azure Database for PostgreSQL에 대한 액세스 권한 부여

1. Azure Data Studio를 열고 위의 관리자로 설정한 **데모** 사용자를 사용하여 Azure Database for PostgreSQL 서버에 연결합니다.
1. 쿼리 창에서 postgres 데이터베이스에 대해 이 코드를 실행합니다. 연결하는 데 사용하는 **데모** 역할을 포함하여 12개의 사용자 역할이 반환되어야 합니다.

    ```SQL
    SELECT rolname FROM pg_catalog.pg_roles;
    ```

1. 새 역할을 만들려면 이 코드를 실행합니다

    ```SQL
    CREATE ROLE dbuser WITH LOGIN NOSUPERUSER INHERIT CREATEDB NOCREATEROLE NOREPLICATION PASSWORD 'R3placeWithAComplexPW!';
    GRANT CONNECT ON DATABASE zoodb TO dbuser;
    ```
    > [!NOTE]
    > 복잡한 암호의 경우 위의 스크립트에서 암호를 바꿔야 합니다.

1. 새 역할을 나열하려면 **pg_catalog.pg_roles**에서 위의 SELECT 쿼리를 다시 실행합니다. **dbuser** 역할이 나열되어 있어야 합니다.
1. **zoodb** 데이터베이스의 **animal** 테이블에서 데이터를 쿼리하고 수정하는 새 역할을 사용하도록 설정하려면 다음 코드를 zoodb 데이터베이스에 대해 실행합니다.

    ```SQL
    GRANT SELECT, INSERT, UPDATE, DELETE ON animal TO dbuser;
    ```

## 새 역할 테스트

1. Azure Data Studio의 **연결** 목록에서 새 연결 단추를 선택합니다.
1. **연결 유형** 목록에서 **PostgreSQL**을 선택합니다.
1. **서버 이름** 텍스트 상자에 Azure Database for PostgreSQL 리소스의 정규화된 서버 이름을 입력합니다. Azure Portal에서 복사할 수 있습니다.
1. **인증 유형** 목록에서 **암호**를 선택합니다.
1. **사용자 이름** 텍스트 상자에 **dbuser**을 입력하고 **암호** 텍스트 상자에 계정을 만들 때 사용하는 복잡한 암호를 입력합니다.
1. **암호 저장** 확인란을 선택한 후 **연결**을 선택합니다.
1. **새 쿼리**를 선택한 다음, 다음 코드를 실행합니다.

    ```SQL
    SELECT * FROM animal;
    ```

1. UPDATE 권한이 있는지 테스트하려면 다음 코드를 실행합니다.

    ```SQL
    UPDATE animal SET name = 'Linda Lioness' WHERE ani_id = 7;
    SELECT * FROM animal;
    ```

1. DROP 권한이 있는지 테스트하려면 다음 코드를 실행합니다. 오류가 있는 경우 다음 오류 코드를 확인합니다.

    ```SQL
    DROP TABLE animal;
    ```

1. GRANT 권한이 있는지 테스트하려면 다음 코드를 실행합니다.

    ```SQL
    GRANT ALL PRIVILEGES ON animal TO dbuser;
    ```

이러한 테스트는 새 사용자가 DML(데이터 조작 언어) 명령을 실행하여 데이터를 쿼리하고 수정할 수 있지만 DDL(데이터 정의 언어) 명령을 사용하여 스키마를 변경할 수 없음을 보여 줍니다. 또한 새 사용자는 새 권한을 부여하여 권한을 우회할 수 없습니다.

## 정리

이 PostgreSQL 서버는 다시 사용하지 않으므로 만든 리소스 그룹을 삭제하여 서버를 제거하세요.
